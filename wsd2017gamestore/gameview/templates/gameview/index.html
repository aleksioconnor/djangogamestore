<h2>{{game.name}}</h2>
<div id="frame_div"></div>
<div id="message"></div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<div>{{game.name}}</div>
<div id="scores"></div>
<script type="text/javascript">


	// TODO: ALL THIS TO ITS INDEPENDENT JAVASCRIPT FILE
  var url = "{{ game.url }}"
  var iframeSource = url
   // Create the iframe
   var iframe = document.createElement('iframe');
   iframe.setAttribute('src', iframeSource);
   document.body.appendChild(iframe);

  function bindEvent(element, eventName, eventHandler) {
     if (element.addEventListener){
         element.addEventListener(eventName, eventHandler, false);
     } else if (element.attachEvent) {
         element.attachEvent('on' + eventName, eventHandler);
     }
  };

  var message = document.getElementById('message');
  var height;
  var width;

  bindEvent(window, 'message', function (e) {
      switch(e.data.messageType) {
        case "SCORE":
          saveHighScore(e.data.score)
          message.innerHTML = e.data.score;
          break;
        case "SAVE":
          message.innerHTML = e.data.messageType;
          break;
        case "LOAD_REQUEST":
          message.innerHTML = e.data.messageType;
          break;
        case "LOAD":
          message.innerHTML = e.data.messageType;
          break;
        case "ERROR":
          message.innerHTML = e.data.info;
          break;
        case "SETTING":
          // change the size of the iframe according to given options
          iframe.style.height = e.data.options.height + 'px';
          iframe.style.width = e.data.options.width + 'px';
            break;
        default:
          message.innerHTML = "";
      }
  });

  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
  }
  var csrftoken = getCookie('csrftoken');

  function saveHighScore(score) {
    $.ajax({
      type: "POST",
      data: {
        'score': score,
        'csrfmiddlewaretoken': csrftoken,
      },
      url: "score/",
      success: function(result) {
        parseJson(result);
      }
    })
  }

  // Functions parses json data received from django
  // and adds it to html
  // data is returned as string from django
  // TODO: This function should receive this data from the view BEFORE player submits data.
  // This is now just an example how it could work.
  function parseJson(data) {
    var scoreDiv = $('#scores');
    var json = JSON.parse(data);
    scoreDiv.empty();

    $.each(json, function(index, value){
      scoreDiv.append((index + 1) + ". Player: " + value.fields.player + ", Score: " + value.fields.score + "<br>");
    });
  }

</script>
<br>
<a type="button" href="payment/">Buy this game</a>
